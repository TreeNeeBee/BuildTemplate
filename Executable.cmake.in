#===============================================================================
# LightAP Executable Build Template
# Version: 1.1.0
#
# This template handles building executables for LightAP modules.
# It automatically collects sources, configures include paths, and sets up
# installation rules.
#
# Required Variables:
#   MODULE_NAME         - Module name (e.g., "MyApp")
#   MODULE_VERNO        - Version number (e.g., "1.0.0")
#   MODULE_SOURCE_*_DIR - Source directories (C and/or C++)
#
# Optional Variables:
#   MODULE_EXTERNAL_LIB         - External libraries to link
#   MODULE_EXTERNAL_INCLUDE_DIR - External include directories
#   MODULE_EXTERNAL_LIB_DIR     - External library directories
#   ENABLE_BUILD_WITH_PLATFORM_PREX - Use platform prefix (default: ON)
#
# Example:
#   set(ENABLE_BUILD_EXECUTABLE ON)
#   set(MODULE_NAME "MyApp")
#   set(MODULE_VERNO "1.0.0")
#   set(MODULE_SOURCE_CXX_DIR ${CMAKE_CURRENT_SOURCE_DIR}/source)
#   include(BuildTemplate/Executable.cmake.in)
#===============================================================================

if(NOT ENABLE_BUILD_EXECUTABLE)
    return()
endif()

message(STATUS "[Executable] Building executable for ${MODULE_NAME}")

#===============================================================================
# Validate Required Variables
#===============================================================================

lap_require_variable(MODULE_NAME 
    "[Executable] MODULE_NAME is required but not defined")
lap_require_variable(MODULE_VERNO 
    "[Executable] MODULE_VERNO is required but not defined")

if(NOT DEFINED MODULE_SOURCE_C_DIR AND NOT DEFINED MODULE_SOURCE_CXX_DIR)
    message(FATAL_ERROR 
        "[Executable] At least one of MODULE_SOURCE_C_DIR or MODULE_SOURCE_CXX_DIR must be defined")
endif()

#===============================================================================
# Executable Name Configuration
#===============================================================================

string(TOLOWER ${MODULE_NAME} LOWER_MODULE_NAME)

if(ENABLE_BUILD_WITH_PLATFORM_PREX)
    set(LOCAL_EXECUTE_NAME ${PLATFORM_SYSTEM_TARGET}_${LOWER_MODULE_NAME})
else()
    set(LOCAL_EXECUTE_NAME ${LOWER_MODULE_NAME})
endif()

# Parse version number
set(LOCAL_EXECUTE_VERNO ${MODULE_VERNO})
string(REPLACE "." ";" LIST_EXECUTE_VERNO ${LOCAL_EXECUTE_VERNO})
list(GET LIST_EXECUTE_VERNO 0 BUILD_EXECUTE_SOVERNO)

message(STATUS "[Executable] Executable name: ${LOCAL_EXECUTE_NAME}")
message(STATUS "[Executable] Version: ${LOCAL_EXECUTE_VERNO}")

#===============================================================================
# Source Collection
#===============================================================================

set(LOCAL_EXECUTE_C_HEADERS "")
set(LOCAL_EXECUTE_C_SOURCES "")
set(LOCAL_EXECUTE_CXX_HEADERS "")
set(LOCAL_EXECUTE_CXX_SOURCES "")

# Collect C sources
if(DEFINED MODULE_SOURCE_C_DIR)
    lap_validate_directory("${MODULE_SOURCE_C_DIR}" "MODULE_SOURCE_C_DIR")
    file(GLOB_RECURSE LOCAL_EXECUTE_C_HEADERS CONFIGURE_DEPENDS 
        "${MODULE_SOURCE_C_DIR}/*.h")
    file(GLOB_RECURSE LOCAL_EXECUTE_C_SOURCES CONFIGURE_DEPENDS 
        "${MODULE_SOURCE_C_DIR}/*.c")
    list(LENGTH LOCAL_EXECUTE_C_SOURCES C_SOURCE_COUNT)
    message(STATUS "[Executable] Found ${C_SOURCE_COUNT} C source files")
endif()

# Collect C++ sources
if(DEFINED MODULE_SOURCE_CXX_DIR)
    lap_validate_directory("${MODULE_SOURCE_CXX_DIR}" "MODULE_SOURCE_CXX_DIR")
    file(GLOB_RECURSE LOCAL_EXECUTE_CXX_HEADERS CONFIGURE_DEPENDS 
        "${MODULE_SOURCE_CXX_DIR}/*.h"
        "${MODULE_SOURCE_CXX_DIR}/*.hpp"
        "${MODULE_SOURCE_CXX_DIR}/*.hxx")
    file(GLOB_RECURSE LOCAL_EXECUTE_CXX_SOURCES CONFIGURE_DEPENDS 
        "${MODULE_SOURCE_CXX_DIR}/*.cpp"
        "${MODULE_SOURCE_CXX_DIR}/*.cxx"
        "${MODULE_SOURCE_CXX_DIR}/*.cc"
        "${MODULE_SOURCE_CXX_DIR}/*.c++")
    
    list(LENGTH LOCAL_EXECUTE_CXX_SOURCES CXX_SOURCE_COUNT)
    message(STATUS "[Executable] Found ${CXX_SOURCE_COUNT} C++ source files")
endif()

# Verify we have sources
if(NOT LOCAL_EXECUTE_C_SOURCES AND NOT LOCAL_EXECUTE_CXX_SOURCES)
    message(FATAL_ERROR "[Executable] No source files found in specified directories")
endif()

#===============================================================================
# Include Directory Configuration
#===============================================================================

set(LOCAL_EXECUTE_INCLUDE_DIRS "")

# Extract include directories from headers
foreach(_headerFile ${LOCAL_EXECUTE_C_HEADERS} ${LOCAL_EXECUTE_CXX_HEADERS})
    get_filename_component(_dir ${_headerFile} DIRECTORY)
    list(APPEND LOCAL_EXECUTE_INCLUDE_DIRS ${_dir})
endforeach()

# Add standard include directories
list(APPEND LOCAL_EXECUTE_INCLUDE_DIRS 
    ${CMAKE_CURRENT_BINARY_DIR}
    ${MODULE_EXTERNAL_INCLUDE_DIR}
)

# Remove duplicates
list(REMOVE_DUPLICATES LOCAL_EXECUTE_INCLUDE_DIRS)

#===============================================================================
# Build Configuration
#===============================================================================

# Create executable
add_executable(${LOCAL_EXECUTE_NAME} 
    ${LOCAL_EXECUTE_C_SOURCES} 
    ${LOCAL_EXECUTE_CXX_SOURCES}
)

# Apply LightAP standard C++ configuration
if(COMMAND lap_configure_cxx_target)
    lap_configure_cxx_target(TARGET ${LOCAL_EXECUTE_NAME})
else()
    message(WARNING "[Executable] lap_configure_cxx_target not available, using fallback")
    set_target_properties(${LOCAL_EXECUTE_NAME} PROPERTIES
        CXX_STANDARD ${CMAKE_CXX_STANDARD}
        CXX_STANDARD_REQUIRED ON
        CXX_EXTENSIONS OFF
    )
endif()

# Set executable properties
set_target_properties(${LOCAL_EXECUTE_NAME} PROPERTIES
    VERSION ${LOCAL_EXECUTE_VERNO}
    OUTPUT_NAME ${LOCAL_EXECUTE_NAME}
)

# Strip symbols in release builds
if(BUILD_WITH_STRIP)
    set_target_properties(${LOCAL_EXECUTE_NAME} PROPERTIES 
        LINK_FLAGS_RELEASE -s
    )
endif()

# Modern CMake: Use target_* commands
target_include_directories(${LOCAL_EXECUTE_NAME} 
    PRIVATE 
        ${SDK_INCLUDE_DIR}
        ${LOCAL_EXECUTE_INCLUDE_DIRS}
        ${MODULE_EXTERNAL_INCLUDE_DIR}
)

target_link_directories(${LOCAL_EXECUTE_NAME} 
    PRIVATE 
        ${SDK_LIB_DIR}
        ${CMAKE_CURRENT_BINARY_DIR}
        ${MODULE_EXTERNAL_LIB_DIR}
)

# Link external libraries
if(DEFINED MODULE_EXTERNAL_LIB)
    target_link_libraries(${LOCAL_EXECUTE_NAME} PRIVATE ${MODULE_EXTERNAL_LIB})
endif()

#===============================================================================
# Installation Rules
#===============================================================================

set(LOCAL_INSTALL_BIN_DIR ${INSTALL_BIN_ROOT_DIR})

# Install executable
install(TARGETS ${LOCAL_EXECUTE_NAME}
    RUNTIME DESTINATION ${LOCAL_INSTALL_BIN_DIR}
        COMPONENT Runtime
)

# Install any associated configuration files or scripts
if(DEFINED MODULE_INSTALL_CONFIG_DIR AND EXISTS "${MODULE_INSTALL_CONFIG_DIR}")
    install(DIRECTORY ${MODULE_INSTALL_CONFIG_DIR}/ 
        DESTINATION ${CMAKE_INSTALL_PREFIX}/etc/${LOWER_MODULE_NAME}
        COMPONENT Runtime
    )
endif()

message(STATUS "[Executable] Configuration complete for ${LOCAL_EXECUTE_NAME}")
