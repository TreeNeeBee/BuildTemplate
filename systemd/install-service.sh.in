#!/bin/bash
#===============================================================================
# LightAP Systemd Service Installation Script
# Automatically generated by CMake from BuildTemplate/systemd/install-service.sh.in
#
# This script is executed during 'make install' to register the daemon
# as a systemd service
#===============================================================================

set -e

SERVICE_NAME="@DaemonService@.service"
SERVICE_FILE="@CMAKE_INSTALL_PREFIX@/lib/systemd/system/${SERVICE_NAME}"
PRESET_FILE="@CMAKE_INSTALL_PREFIX@/lib/systemd/system-preset/98-@DaemonService@.preset"

echo "==================================================================="
echo "Installing systemd service: ${SERVICE_NAME}"
echo "==================================================================="

# Check if running with sufficient privileges
if [ "$EUID" -eq 0 ]; then
    SYSTEMCTL_CMD="systemctl"
    INSTALL_MODE="system"
else
    echo "Warning: Not running as root. Service will be installed but not enabled."
    echo "To enable the service, run: sudo systemctl enable ${SERVICE_NAME}"
    SYSTEMCTL_CMD="systemctl --user"
    INSTALL_MODE="user"
fi

# Verify service file exists
if [ ! -f "${SERVICE_FILE}" ]; then
    echo "Error: Service file not found: ${SERVICE_FILE}"
    exit 1
fi

echo "Service file: ${SERVICE_FILE}"
echo "Install mode: ${INSTALL_MODE}"

# Only proceed with systemd operations if running as root
if [ "$EUID" -eq 0 ]; then
    # Reload systemd daemon to recognize new service
    echo "Reloading systemd daemon..."
    systemctl daemon-reload
    
    # Apply preset to enable service by default
    if [ -f "${PRESET_FILE}" ]; then
        echo "Applying systemd preset..."
        systemctl preset "${SERVICE_NAME}" || true
    fi
    
    # Optionally enable the service
    if [ "@DaemonAutoEnable@" = "ON" ]; then
        echo "Enabling ${SERVICE_NAME}..."
        systemctl enable "${SERVICE_NAME}"
        echo "Service enabled successfully."
    else
        echo "Service installed but not enabled (use: systemctl enable ${SERVICE_NAME})"
    fi
    
    # Optionally start the service
    if [ "@DaemonAutoStart@" = "ON" ]; then
        echo "Starting ${SERVICE_NAME}..."
        systemctl start "${SERVICE_NAME}"
        echo "Service started successfully."
        
        # Show service status
        echo ""
        echo "Service status:"
        systemctl status "${SERVICE_NAME}" --no-pager || true
    else
        echo "Service not started (use: systemctl start ${SERVICE_NAME})"
    fi
    
    echo ""
    echo "==================================================================="
    echo "Service management commands:"
    echo "  Start:   systemctl start ${SERVICE_NAME}"
    echo "  Stop:    systemctl stop ${SERVICE_NAME}"
    echo "  Restart: systemctl restart ${SERVICE_NAME}"
    echo "  Status:  systemctl status ${SERVICE_NAME}"
    echo "  Logs:    journalctl -u ${SERVICE_NAME} -f"
    echo "==================================================================="
else
    echo ""
    echo "==================================================================="
    echo "Service installed but not registered with systemd."
    echo "To register and enable the service, run as root:"
    echo "  sudo systemctl daemon-reload"
    echo "  sudo systemctl enable ${SERVICE_NAME}"
    echo "  sudo systemctl start ${SERVICE_NAME}"
    echo "==================================================================="
fi

exit 0
